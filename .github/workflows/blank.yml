name: RDP Remote Windows Pro

on:
  workflow_dispatch:
    inputs:
      session_duration:
        description: "Session duration (e.g., 1h, 3h, 5h40m, 8h)"
        required: false
        default: "3h"
        type: choice
        options: ["1h", "3h", "5h40m", "72h"]

jobs:
  rdp-pro:
    runs-on: [ self-hosted, windows ]

    steps:
    - name: Welcome Banner
      shell: powershell
      run: |
        Write-Host "========================================="
        Write-Host "    WELCOME TO RDP PROFESSIONAL SETUP    "
        Write-Host "========================================="
        for ($i=0; $i -le 100; $i+=5) {
            Write-Host "Loading: $i%" -NoNewline
            Start-Sleep -Milliseconds 100
            Write-Host "`r"
        }
        Write-Host "`nInitialization complete."

    - name: Advanced Configuration - Premium User
      shell: powershell
      id: user
      run: |
        $username = "premiumuser"
        # Secure random password: 16 chars, 4 symbols
        $password = [System.Web.Security.Membership]::GeneratePassword(16,4)
        
        # Create user if not exists
        if (-not (Get-LocalUser -Name $username -ErrorAction SilentlyContinue)) {
            net user $username $password /add
            net localgroup Administrators $username /add
            Write-Host "✅ Premium user created: $username"
        } else {
            Write-Host "⚠ User already exists: $username"
        }

        # Save credentials securely in environment variables
        echo "RDP_USERNAME=$username" >> $env:GITHUB_ENV
        echo "RDP_PASSWORD=$password" >> $env:GITHUB_ENV

    - name: Check Login Rights & RDP Service
      shell: powershell
      run: |
        Write-Host "Checking user privileges..."
        whoami /groups
        net localgroup Administrators
        Write-Host "Checking RDP Service..."
        $rdp = Get-Service -Name TermService
        Write-Host "RDP Service status: $($rdp.Status)"
        if ($rdp.Status -ne 'Running') {
            Start-Service -Name TermService
            Write-Host "RDP Service started"
        }

    - name: Tailscale Premium Setup
      shell: powershell
      env:
        TAILSCALE_AUTHKEY: ${{ secrets.TAILSCALE_AUTHKEY }}
      run: |
        Write-Host "Installing Tailscale..."
        Invoke-WebRequest "https://pkgs.tailscale.com/stable/tailscale-setup-latest.exe" -OutFile "tailscale.exe"
        Start-Process ".\tailscale.exe" -ArgumentList "/quiet" -Wait

        Write-Host "Connecting to Tailscale..."
        $success = $false
        for ($i=0; $i -lt 5; $i++) {
            try {
                & "C:\Program Files\Tailscale\tailscale.exe" up --authkey $env:TAILSCALE_AUTHKEY --hostname "windows-rdp-pro" --accept-routes --ssh
                $ip = & "C:\Program Files\Tailscale\tailscale.exe" ip -4
                if ($ip) { $success = $true; break }
            } catch { Start-Sleep -Seconds 5 }
        }
        if (-not $success) { throw "Tailscale failed to connect." }
        Write-Host "Tailscale IP: $ip"

    - name: Convert Time & Save Duration
      shell: powershell
      run: |
        $durationStr = "${{ github.event.inputs.session_duration }}"
        $timespan = [System.TimeSpan]::Parse($durationStr)
        $minutes = [math]::Round($timespan.TotalMinutes)
        Write-Host "Session duration in minutes: $minutes"
        echo "SESSION_MINUTES=$minutes" >> $env:GITHUB_ENV

    - name: Maintain Stable Session - Monitoring
      shell: powershell
      run: |
        Write-Host "Starting session monitoring..."
        $durationSeconds = $env:SESSION_MINUTES * 60
        $startTime = Get-Date
        $endTime = $startTime.AddSeconds($durationSeconds)
        Write-Host "Session will run until: $endTime"

        Start-Job -ScriptBlock {
            while ($true) {
                $rdp = Get-Service -Name TermService
                if ($rdp.Status -ne 'Running') { Start-Service -Name TermService; Write-Host "$(Get-Date): Restarted RDP service" }
                Write-Host "$(Get-Date): RDP service running, user: $env:RDP_USERNAME"
                Start-Sleep -Seconds 120
                if (Get-Date -gt $using:endTime) { break }
            }
        }

    - name: Display Interface / Timer
      shell: powershell
      run: |
        Write-Host "====================================="
        Write-Host " RDP Session Active for $($env:SESSION_MINUTES) minutes"
        Write-Host " User: $($env:RDP_USERNAME)"
        Write-Host " Connect via Tailscale IP: $ip"
        Write-Host "====================================="

    - name: Professional Cleanup
      if: always()
      shell: powershell
      run: |
        Write-Host "Starting professional cleanup..."
        # Delete user
        if (Get-LocalUser -Name $env:RDP_USERNAME -ErrorAction SilentlyContinue) {
            net user $env:RDP_USERNAME /delete
            Write-Host "Deleted temporary user."
        }

        # Disable RDP
        Set-ItemProperty 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name 'fDenyTSConnections' -Value 1

        # Remove firewall rules
        Disable-NetFirewallRule -DisplayGroup "Remote Desktop"

        # Disconnect Tailscale
        $tailscaleExe = "C:\Program Files\Tailscale\tailscale.exe"
        if (Test-Path $tailscaleExe) { & $tailscaleExe down }

        Write-Host "✅ Cleanup complete. All temporary resources removed."
