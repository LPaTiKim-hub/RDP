
name: RDP Remote Windows Ultra Pro v4

on:
  workflow_dispatch:
    inputs:
      session_duration:
        description: "Session duration (e.g., 1h, 3h, 5h40m, 72h)"
        required: false
        default: "72h"
        type: choice
        options: ["1h","3h","5h40m","72h"]

jobs:
  rdp-ultra-pro-v4:
    runs-on: windows-latest

    steps:
    # Welcome Banner + Loading
    - name: Welcome Banner + Loading
      shell: powershell
      run: |
        Write-Host "======================================"
        Write-Host "      WELCOME TO ULTRA PRO v4 RDP      "
        Write-Host "======================================"
        for ($i=0; $i -le 100; $i+=5) {
            Write-Host "Loading: $i%" -NoNewline
            Start-Sleep -Milliseconds 50
            Write-Host "`r"
        }
        Write-Host "`nInitialization complete."

    # Backup current config
    - name: Backup Configuration
      shell: powershell
      run: |
        Write-Host "Backing up RDP and firewall settings..."
        $backup=@{
            Firewall=Get-NetFirewallRule | Select Name, DisplayName, Enabled, Direction, Profile, Action
            RDP=Get-ItemProperty 'HKLM:\System\CurrentControlSet\Control\Terminal Server'
        }
        Export-Clixml -InputObject $backup -Path "C:\rdp-backup-settings.xml"
        Write-Host "Backup saved at C:\rdp-backup-settings.xml"

    # Create Premium User with password rotation
    - name: Create Premium User
      shell: powershell
      id: user
      run: |
        $username="ultra_v4_user"
        $password=[System.Web.Security.Membership]::GeneratePassword(20,6)
        if (Get-LocalUser -Name $username -ErrorAction SilentlyContinue) { net user $username /delete }
        net user $username $password /add
        net localgroup Administrators $username /add
        Write-Host "✅ Premium user created: $username"
        echo "RDP_USERNAME=$username" >> $env:GITHUB_ENV
        echo "RDP_PASSWORD=$password" >> $env:GITHUB_ENV

    # Validate user/admin rights & RDP service
    - name: Validate User & RDP Service
      shell: powershell
      run: |
        net localgroup Administrators | Select-String $env:RDP_USERNAME
        $rdp=Get-Service TermService
        if ($rdp.Status -ne "Running") { Start-Service TermService }

    # Install and connect Tailscale with retry
          
    - name: Tailscale VPN Setup
      shell: powershell
      env:
        TAILSCALE_AUTHKEY: ${{ secrets.TAILSCALE_AUTHKEY }}
        ALERT_WEBHOOK_URL: ${{ secrets.RDP_ALERT_WEBHOOK }}
      run: |
        $msiPath = "$env:TEMP\tailscale-premium.msi"
              Invoke-WebRequest -Uri "https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi" -OutFile $msiPath
              Start-Process msiexec.exe -ArgumentList "/i", "`"$msiPath`"", "/quiet" -Wait
    
        $connected=$false
        for ($i=0; $i -lt 5; $i++) {
            try {
                & "C:\Program Files\Tailscale\msiexec.exe" up --authkey $env:TAILSCALE_AUTHKEY --hostname "ultra-pro-v4" --accept-routes --ssh
                $ip = & "C:\Program Files\Tailscale\msiexec.exe" ip -4
                if ($ip) { $connected=$true; break }
            } catch { Start-Sleep -Seconds 5 }
        }
        if (-not $connected) {
            $msg="⚠ Tailscale connection failed!"
            Write-Warning $msg
            Add-Content -Path $logFile -Value "$(Get-Date) | $msg"
            if ($env:ALERT_WEBHOOK_URL) {
                Invoke-WebRequest -Uri $env:ALERT_WEBHOOK_URL -Method Post -Body (@{text=$msg} | ConvertTo-Json) -ContentType 'application/json'
            }
        }
        Write-Host "Tailscale IP: $ip"

    # Convert duration and save environment variable
    - name: Convert Duration
      shell: powershell
      run: |
        $ts=[System.TimeSpan]::Parse("${{ github.event.inputs.session_duration }}")
        $minutes=[math]::Round($ts.TotalMinutes)
        echo "SESSION_MINUTES=$minutes" >> $env:GITHUB_ENV
        Write-Host "Session duration: $minutes minutes"

    # Maintain stable session + persistent logging + alert system
    - name: Monitor Session & Send Alerts
      shell: powershell
      run: |
        $logFile="C:\rdp-session.log"
        $endTime=(Get-Date).AddMinutes($env:SESSION_MINUTES)
        Write-Host "Monitoring session until: $endTime. Logs saved to $logFile"

        Start-Job -ScriptBlock {
            while ($true) {
                $service=Get-Service TermService
                if ($service.Status -ne 'Running') {
                    Start-Service TermService
                    $msg="$(Get-Date) | RDP Service restarted"
                    Add-Content -Path $using:logFile -Value $msg
                    Write-Host $msg
                    if ($env:ALERT_WEBHOOK_URL) { Invoke-WebRequest -Uri $env:ALERT_WEBHOOK_URL -Method Post -Body (@{text=$msg}|ConvertTo-Json) -ContentType 'application/json' }
                } else {
                    $msg="$(Get-Date) | RDP Service running"
                    Add-Content -Path $using:logFile -Value $msg
                }

                # Check Tailscale
                try {
                    $ip = & "C:\Program Files\Tailscale\msiexec.exe" ip -4
                    if (-not $ip) {
                        $msg="$(Get-Date) | Tailscale disconnected!"
                        Add-Content -Path $using:logFile -Value $msg
                        Write-Host $msg
                        if ($env:ALERT_WEBHOOK_URL) { Invoke-WebRequest -Uri $env:ALERT_WEBHOOK_URL -Method Post -Body (@{text=$msg}|ConvertTo-Json) -ContentType 'application/json' }
                    }
                } catch {}

                Start-Sleep -Seconds 120
                if (Get-Date -gt $using:endTime) { break }
            }
        }

    # Display Interface & Timer
    - name: Display Interface
      shell: powershell
      run: |
        Write-Host "=============================================="
        Write-Host "  ULTRA PRO v4 RDP SESSION ACTIVE"
        Write-Host "  User: $($env:RDP_USERNAME)"
        Write-Host "  Tailscale IP: $ip"
        Write-Host "  Logs: C:\rdp-session.log"
        Write-Host "  Remaining time: $($env:SESSION_MINUTES) minutes"
        Write-Host "=============================================="

    # Professional Cleanup + Rollback
    - name: Cleanup & Rollback
      if: always()
      shell: powershell
      run: |
        Write-Host "✅ Starting cleanup..."
        try {
            if (Get-LocalUser -Name $env:RDP_USERNAME -ErrorAction SilentlyContinue) {
                net user $env:RDP_USERNAME /delete
            }
            Set-ItemProperty 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name 'fDenyTSConnections' -Value 1
            Disable-NetFirewallRule -DisplayGroup "Remote Desktop"
            $tsExe="C:\Program Files\Tailscale\msiexec.exe"
            if (Test-Path $tsExe) { & $tsExe down }

            # Restore from backup
            if (Test-Path "C:\rdp-backup-settings.xml") {
                $backup=Import-Clixml "C:\rdp-backup-settings.xml"
                foreach ($rule in $backup.Firewall) {
                    if (-not (Get-NetFirewallRule -Name $rule.Name -ErrorAction SilentlyContinue)) {
                        New-NetFirewallRule -Name $rule.Name -DisplayName $rule.DisplayName -Direction $rule.Direction -Profile $rule.Profile -Action $rule.Action
                    }
                }
                foreach ($prop in $backup.RDP.PSObject.Properties) {
                    Set-ItemProperty 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name $prop.Name -Value $prop.Value
                }
            }
            Write-Host "✅ Cleanup and rollback complete."
        } catch {
            Write-Warning "Cleanup encountered an issue: $_"
        }
