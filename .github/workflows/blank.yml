name: Premium-RDP-Ubuntu-v2

on:
  workflow_dispatch:
    inputs:
      session_duration:
        description: "Session duration in minutes"
        required: false
        default: 180

jobs:
  premium-rdp:
    runs-on: ubuntu-latest

    steps:
    # Update and install dependencies
    - name: Update System
      run: |
        sudo apt-get update -y
        sudo apt-get upgrade -y
        sudo apt-get install -y curl gnupg lsb-release xrdp xfce4 xfce4-terminal

    # Install Tailscale
    - name: Install Tailscale
      run: |
        curl -fsSL https://tailscale.com/install.sh | sh

    # Connect Tailscale
    - name: Connect Tailscale
      env:
        TAILSCALE_AUTHKEY: ${{ secrets.TAILSCALE_AUTHKEY }}
      run: |
        sudo tailscale up --authkey $TAILSCALE_AUTHKEY --hostname "premium-rdp-ubuntu-v2"

    # Display Tailscale IP
    - name: Show Tailscale IP
      run: |
        tailscale ip -4

    # Create premium user
    - name: Create Premium User
      env:
        SESSION_DURATION: ${{ github.event.inputs.session_duration }}
      run: |
        USERNAME="premiumuser"
        PASSWORD=$(openssl rand -base64 16)
        sudo useradd -m -s /bin/bash $USERNAME
        echo "$USERNAME:$PASSWORD" | sudo chpasswd
        sudo usermod -aG sudo $USERNAME
        echo "USERNAME=$USERNAME" >> $GITHUB_ENV
        echo "PASSWORD=$PASSWORD" >> $GITHUB_ENV
        echo "Premium user created. Session duration: $SESSION_DURATION minutes."

    # Configure xRDP
    - name: Configure xRDP
      run: |
        sudo systemctl enable xrdp
        sudo systemctl restart xrdp
        echo "xRDP service started."

    # Monitor session and auto cleanup
    - name: Session Monitor & Cleanup
      shell: bash
      env:
        USERNAME: ${{ env.USERNAME }}
        SESSION_DURATION: ${{ env.SESSION_DURATION }}
      run: |
        echo "Monitoring session for $SESSION_DURATION minutes..."
        END_TIME=$(( $(date +%s) + $SESSION_DURATION*60 ))
        while [ $(date +%s) -lt $END_TIME ]; do
          # Check xRDP service
          if ! systemctl is-active --quiet xrdp; then
            echo "$(date) | xRDP service down. Restarting..."
            sudo systemctl restart xrdp
          fi
          sleep 60
        done
        echo "Session ended. Cleaning up..."
        sudo deluser --remove-home $USERNAME
        sudo systemctl stop xrdp
        echo "Cleanup complete."
